<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HR Interview Practice - AI Feedback</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --primary: #667eea;
            --accent: #e74c3c;
            --success: #27ae60;
            --warning: #f39c12;
            --info: #3498db;
            --bg: #ffffff;
            --text: #2c3e50;
            --border: #e9ecef;
            --light: #f8f9fa;
        }

        [data-theme="dark"] {
            --bg: #1e1e1e;
            --text: #e0e0e0;
            --border: #333;
            --light: #2d2d2d;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Inter', -apple-system, sans-serif; background: linear-gradient(135deg, var(--primary) 0%, #764ba2 100%); min-height: 100vh; color: var(--text); transition: all 0.3s ease; }
        .container { max-width: 1400px; margin: 0 auto; background: var(--bg); min-height: 100vh; }
        
        .header { background: linear-gradient(135deg, var(--accent), #c0392b); color: white; padding: 1.5rem 2rem; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .logo { display: flex; align-items: center; gap: 1rem; font-size: 1.3rem; font-weight: 700; }
        .header-right { display: flex; gap: 1rem; align-items: center; }
        .theme-toggle { background: rgba(255,255,255,0.2); border: none; color: white; padding: 0.5rem 1rem; border-radius: 8px; cursor: pointer; transition: all 0.3s; }
        .theme-toggle:hover { background: rgba(255,255,255,0.3); }
        .back-btn { color: white; text-decoration: none; padding: 0.5rem 1rem; border-radius: 8px; background: rgba(255,255,255,0.1); transition: all 0.3s; }
        .back-btn:hover { background: rgba(255,255,255,0.2); }
        
        .main-content { padding: 2rem; }
        .tabs { display: flex; gap: 1rem; margin-bottom: 2rem; border-bottom: 2px solid var(--border); }
        .tab-btn { padding: 1rem 1.5rem; background: none; border: none; cursor: pointer; font-weight: 600; color: var(--text); border-bottom: 3px solid transparent; transition: all 0.3s; }
        .tab-btn.active { color: var(--accent); border-bottom-color: var(--accent); }
        
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        .intro-section { text-align: center; padding: 3rem 0; }
        .intro-section h2 { font-size: 2.5rem; margin-bottom: 1rem; color: var(--accent); }
        .intro-section p { font-size: 1.1rem; color: var(--text); margin-bottom: 2rem; }
        
        .action-buttons { display: flex; gap: 1rem; justify-content: center; margin-top: 2rem; flex-wrap: wrap; }
        .btn { padding: 1rem 2rem; border: none; border-radius: 10px; font-size: 1rem; font-weight: 600; cursor: pointer; transition: all 0.3s; display: inline-flex; align-items: center; gap: 0.5rem; }
        .btn-primary { background: linear-gradient(135deg, var(--accent), #c0392b); color: white; }
        .btn-primary:hover { transform: translateY(-3px); box-shadow: 0 8px 20px rgba(231, 76, 60, 0.3); }
        .btn-secondary { background: #6c757d; color: white; }
        .btn-secondary:hover { background: #5a6268; }
        
        .questions-section { display: none; }
        .question-card { background: var(--bg); border: 2px solid var(--border); border-radius: 15px; padding: 2rem; margin-bottom: 2rem; box-shadow: 0 2px 10px rgba(0,0,0,0.05); transition: all 0.3s; }
        .question-card:hover { box-shadow: 0 4px 20px rgba(0,0,0,0.1); }
        
        .question-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; flex-wrap: wrap; gap: 1rem; }
        .question-number { background: var(--accent); color: white; padding: 0.75rem 1.5rem; border-radius: 8px; font-weight: 600; }
        .question-type { background: var(--info); color: white; padding: 0.75rem 1.5rem; border-radius: 8px; font-size: 0.95rem; }
        
        .question-text { font-size: 1.3rem; margin: 1.5rem 0; font-weight: 500; color: var(--text); }
        .question-focus { font-size: 0.9rem; color: var(--warning); margin-bottom: 1rem; }
        
        .answer-section { margin: 1.5rem 0; }
        .answer-label { font-weight: 600; margin-bottom: 0.5rem; color: var(--text); }
        .answer-textarea { width: 100%; min-height: 180px; padding: 1.2rem; border: 2px solid var(--border); border-radius: 10px; font-family: inherit; font-size: 1rem; resize: vertical; background: var(--bg); color: var(--text); transition: all 0.3s; }
        .answer-textarea:focus { outline: none; border-color: var(--accent); box-shadow: 0 0 0 3px rgba(231, 76, 60, 0.1); }
        
        .button-group { display: flex; gap: 1rem; margin-top: 1.5rem; flex-wrap: wrap; }
        .evaluate-btn { background: var(--success); color: white; padding: 1rem 2rem; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.3s; display: inline-flex; align-items: center; gap: 0.5rem; }
        .evaluate-btn:hover { background: #229954; transform: translateY(-2px); }
        .evaluate-btn:disabled { background: #ccc; cursor: not-allowed; transform: none; }
        
        .feedback-panel { margin-top: 2rem; padding: 2rem; background: var(--light); border-left: 5px solid var(--success); border-radius: 10px; display: none; animation: slideIn 0.3s ease; }
        @keyframes slideIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        
        .feedback-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; }
        .feedback-score { font-size: 3rem; font-weight: bold; color: var(--success); }
        .score-out-of { font-size: 1rem; color: var(--text); margin-top: 0.5rem; }
        
        .feedback-content { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem; margin-top: 1.5rem; }
        .feedback-box { padding: 1.5rem; background: var(--bg); border-radius: 10px; border-left: 4px solid var(--info); }
        .feedback-box h4 { color: var(--accent); margin-bottom: 1rem; font-size: 1.1rem; }
        .feedback-list { list-style: none; }
        .feedback-list li { padding: 0.7rem 0; padding-left: 2rem; position: relative; color: var(--text); }
        .feedback-list li:before { content: "âœ“"; position: absolute; left: 0; color: var(--success); font-weight: bold; font-size: 1.2rem; }
        .improvement-list li:before { content: "âš "; color: var(--warning); }
        .suggestion-list li:before { content: "ðŸ’¡"; }
        
        .star-method { margin-top: 1.5rem; }
        .star-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem; margin-top: 1rem; }
        .star-item { text-align: center; padding: 1.5rem; background: var(--bg); border-radius: 10px; border: 2px solid var(--border); }
        .star-item.complete { background: #d4edda; border-color: var(--success); }
        .star-item.incomplete { background: #f8d7da; border-color: var(--warning); }
        
        .loading { text-align: center; padding: 3rem; display: none; }
        .loading-spinner { font-size: 3rem; animation: spin 1s linear infinite; margin-bottom: 1rem; }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        .message { padding: 1rem 1.5rem; border-radius: 8px; margin-bottom: 1rem; display: none; animation: slideIn 0.3s ease; }
        .message.success { background: #d4edda; color: #155724; border-left: 4px solid var(--success); }
        .message.error { background: #f8d7da; color: #721c24; border-left: 4px solid var(--warning); }
        
        .session-controls { display: flex; gap: 1rem; justify-content: center; margin-top: 2rem; flex-wrap: wrap; }
        
        .character-count { font-size: 0.85rem; color: var(--text); margin-top: 0.3rem; }
        .word-count { color: var(--info); }
        
        /* History Styles */
        .history-container { margin-top: 2rem; }
        .history-empty { text-align: center; padding: 3rem; color: var(--text); }
        .history-empty i { font-size: 3rem; margin-bottom: 1rem; color: var(--border); }
        
        .session-item { background: var(--bg); border: 2px solid var(--border); border-radius: 10px; padding: 1.5rem; margin-bottom: 1.5rem; cursor: pointer; transition: all 0.3s; }
        .session-item:hover { box-shadow: 0 4px 15px rgba(0,0,0,0.1); transform: translateY(-2px); }
        
        .session-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; }
        .session-date { font-size: 0.9rem; color: var(--text); }
        .session-badge { background: var(--accent); color: white; padding: 0.5rem 1rem; border-radius: 20px; font-size: 0.85rem; }
        
        .session-details { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem; margin-top: 1rem; }
        .detail-box { padding: 1rem; background: var(--light); border-radius: 8px; text-align: center; }
        .detail-label { font-size: 0.85rem; color: var(--text); }
        .detail-value { font-size: 1.5rem; font-weight: bold; color: var(--accent); }
        
        @media (max-width: 768px) {
            .intro-section h2 { font-size: 1.8rem; }
            .feedback-content { grid-template-columns: 1fr; }
            .header { flex-direction: column; gap: 1rem; }
            .tabs { flex-wrap: wrap; }
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <div class="logo">
                <i class="fas fa-users"></i>
                <span>HR Interview Practice</span>
            </div>
            <div class="header-right">
                <button class="theme-toggle" id="theme-toggle" title="Toggle dark mode"><i class="fas fa-moon"></i></button>
                <a href="/dashboard" class="back-btn"><i class="fas fa-arrow-left"></i> Dashboard</a>
            </div>
        </header>

        <main class="main-content">
            <div id="message" class="message"></div>

            <!-- Tabs -->
            <div class="tabs">
                <button class="tab-btn active" id="practice-tab" onclick="switchTab('practice')">
                    <i class="fas fa-book"></i> Practice
                </button>
                <button class="tab-btn" id="history-tab" onclick="switchTab('history')">
                    <i class="fas fa-history"></i> Session History
                </button>
            </div>

            <!-- Practice Tab -->
            <div id="practice" class="tab-content active">
                <section class="intro-section" id="intro-section">
                    <h2>ðŸŽ¯ HR Interview Simulation</h2>
                    <p>Get personalized questions and instant AI-powered feedback</p>
                    <div class="action-buttons">
                        <button class="btn btn-primary" id="start-interview-btn">
                            <i class="fas fa-play"></i> Start Interview
                        </button>
                        <button class="btn btn-secondary" id="generate-questions-btn">
                            <i class="fas fa-sync"></i> Generate New Questions
                        </button>
                    </div>
                </section>

                <div id="loading" class="loading">
                    <div class="loading-spinner"><i class="fas fa-spinner"></i></div>
                    <p>Generating personalized questions...</p>
                </div>

                <section class="questions-section" id="questions-section">
                    <div id="questions-container"></div>
                    <div class="session-controls">
                        <button class="btn btn-primary" id="submit-session-btn">
                            <i class="fas fa-check-circle"></i> Submit Session
                        </button>
                        <button class="btn btn-secondary" id="cancel-session-btn">
                            <i class="fas fa-times"></i> Cancel
                        </button>
                    </div>
                </section>
            </div>

            <!-- History Tab -->
            <div id="history" class="tab-content">
                <div class="history-container">
                    <h3 style="margin-bottom: 1.5rem;"><i class="fas fa-list"></i> Your Interview Sessions</h3>
                    <div id="history-list"></div>
                </div>
            </div>
        </main>
    </div>

    <script>
        class HRInterviewManager {
            constructor() {
                this.questions = [];
                this.answers = {};
                this.feedbacks = {};
                this.evaluatingIndex = null;
                this.currentSessionData = null;
                this.initTheme();
                this.bindEvents();
                this.loadHistory();
            }

            initTheme() {
                const theme = localStorage.getItem('theme') || 'light';
                document.documentElement.setAttribute('data-theme', theme);
                this.updateThemeIcon(theme);
            }

            updateThemeIcon(theme) {
                const icon = document.querySelector('#theme-toggle i');
                icon.className = theme === 'dark' ? 'fas fa-sun' : 'fas fa-moon';
            }

            bindEvents() {
                document.getElementById('theme-toggle').addEventListener('click', () => this.toggleTheme());
                document.getElementById('start-interview-btn').addEventListener('click', () => this.startInterview());
                document.getElementById('generate-questions-btn').addEventListener('click', () => this.generateQuestions());
                document.getElementById('submit-session-btn').addEventListener('click', () => this.submitSession());
                document.getElementById('cancel-session-btn').addEventListener('click', () => this.cancelSession());
            }

            toggleTheme() {
                const current = document.documentElement.getAttribute('data-theme');
                const newTheme = current === 'dark' ? 'light' : 'dark';
                document.documentElement.setAttribute('data-theme', newTheme);
                localStorage.setItem('theme', newTheme);
                this.updateThemeIcon(newTheme);
            }

            switchTab(tab) {
                document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
                document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
                
                document.getElementById(tab).classList.add('active');
                event.target.closest('.tab-btn').classList.add('active');
                
                if (tab === 'history') {
                    this.loadHistory();
                }
            }

            async generateQuestions() {
                this.showLoading();
                try {
                    const response = await fetch('/api/hr_questions', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' }
                    });
                    const result = await response.json();
                    if (result.success) {
                        this.questions = result.questions;
                        this.showMessage('âœ“ Questions generated! Click "Start Interview" to begin.', 'success');
                    } else {
                        this.showMessage('âœ— Failed to generate questions', 'error');
                    }
                } catch (error) {
                    this.showMessage('âœ— Error: ' + error.message, 'error');
                } finally {
                    this.hideLoading();
                }
            }

            async startInterview() {
                if (this.questions.length === 0) {
                    await this.generateQuestions();
                }
                if (this.questions.length > 0) {
                    this.displayQuestions();
                    document.getElementById('intro-section').style.display = 'none';
                    document.getElementById('questions-section').style.display = 'block';
                    window.scrollTo(0, 0);
                }
            }

            displayQuestions() {
                const container = document.getElementById('questions-container');
                container.innerHTML = '';

                this.questions.forEach((q, index) => {
                    const card = document.createElement('div');
                    card.className = 'question-card';
                    card.innerHTML = `
                        <div class="question-header">
                            <span class="question-number">Q${index + 1}/5</span>
                            <span class="question-type"><i class="fas fa-tag"></i> ${q.type || 'General'}</span>
                        </div>
                        <div class="question-text">${q.question}</div>
                        <div class="question-focus"><i class="fas fa-bullseye"></i> Focus: ${q.focus_area || 'general'}</div>
                        
                        <div class="answer-section">
                            <label class="answer-label">Your Answer:</label>
                            <textarea class="answer-textarea" id="answer-${index}" placeholder="Type your detailed answer here..."></textarea>
                            <div class="character-count">
                                <span id="char-${index}">0</span> characters | 
                                <span id="word-${index}" class="word-count">0</span> words
                            </div>
                        </div>
                        
                        <div class="button-group">
                            <button class="evaluate-btn" onclick="hrManager.evaluateAnswer(${index})">
                                <i class="fas fa-brain"></i> Get AI Feedback
                            </button>
                        </div>
                        
                        <div class="feedback-panel" id="feedback-${index}"></div>
                    `;
                    container.appendChild(card);

                    const textarea = document.getElementById(`answer-${index}`);
                    textarea.addEventListener('input', (e) => {
                        const text = e.target.value;
                        const chars = text.length;
                        const words = text.trim().split(/\s+/).filter(w => w).length;
                        document.getElementById(`char-${index}`).textContent = chars;
                        document.getElementById(`word-${index}`).textContent = words;
                    });
                });
            }

            async evaluateAnswer(index) {
                const textarea = document.getElementById(`answer-${index}`);
                const answer = textarea.value.trim();

                if (!answer) {
                    this.showMessage('âœ— Please write an answer first!', 'error');
                    return;
                }

                if (answer.length < 20) {
                    this.showMessage('âœ— Please provide a more detailed answer', 'error');
                    return;
                }

                const question = this.questions[index];
                const feedbackPanel = document.getElementById(`feedback-${index}`);
                const btn = event.target;

                feedbackPanel.innerHTML = '<div class="loading"><div class="loading-spinner"><i class="fas fa-spinner"></i></div><p>AI is analyzing...</p></div>';
                feedbackPanel.style.display = 'block';
                btn.disabled = true;

                try {
                    const response = await fetch('/api/evaluate_answer', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            question: question.question,
                            answer: answer,
                            type: question.type,
                            focus_area: question.focus_area
                        })
                    });

                    const result = await response.json();
                    if (result.success) {
                        this.displayFeedback(index, result.feedback);
                        this.feedbacks[index] = result.feedback;
                        this.answers[index] = answer;
                    } else {
                        feedbackPanel.innerHTML = '<p style="color: red;">âœ— Failed to get feedback</p>';
                    }
                } catch (error) {
                    feedbackPanel.innerHTML = '<p style="color: red;">âœ— Error: ' + error.message + '</p>';
                } finally {
                    btn.disabled = false;
                }
            }

            displayFeedback(index, feedback) {
                const panel = document.getElementById(`feedback-${index}`);
                const star = feedback.star_method || {};
                
                const starHTML = `
                    <div class="star-grid">
                        <div class="star-item ${star.situation?.present ? 'complete' : 'incomplete'}">
                            <div><strong>S</strong>ituation</div>
                            <div style="font-size: 1.5rem; margin: 0.5rem 0;">${star.situation?.present ? 'âœ“' : 'âœ—'}</div>
                        </div>
                        <div class="star-item ${star.task?.present ? 'complete' : 'incomplete'}">
                            <div><strong>T</strong>ask</div>
                            <div style="font-size: 1.5rem; margin: 0.5rem 0;">${star.task?.present ? 'âœ“' : 'âœ—'}</div>
                        </div>
                        <div class="star-item ${star.action?.present ? 'complete' : 'incomplete'}">
                            <div><strong>A</strong>ction</div>
                            <div style="font-size: 1.5rem; margin: 0.5rem 0;">${star.action?.present ? 'âœ“' : 'âœ—'}</div>
                        </div>
                        <div class="star-item ${star.result?.present ? 'complete' : 'incomplete'}">
                            <div><strong>R</strong>esult</div>
                            <div style="font-size: 1.5rem; margin: 0.5rem 0;">${star.result?.present ? 'âœ“' : 'âœ—'}</div>
                        </div>
                    </div>
                `;

                panel.innerHTML = `
                    <div class="feedback-header">
                        <div>
                            <div class="feedback-score">${feedback.score}</div>
                            <div class="score-out-of">/ 10</div>
                        </div>
                    </div>
                    <p><strong>${feedback.overall_feedback}</strong></p>
                    <div class="feedback-content">
                        <div class="feedback-box">
                            <h4><i class="fas fa-check-circle"></i> Strengths</h4>
                            <ul class="feedback-list">
                                ${feedback.strengths.map(s => `<li>${s}</li>`).join('')}
                            </ul>
                        </div>
                        <div class="feedback-box">
                            <h4><i class="fas fa-exclamation-circle"></i> Improvements</h4>
                            <ul class="feedback-list improvement-list">
                                ${feedback.improvements.map(i => `<li>${i}</li>`).join('')}
                            </ul>
                        </div>
                    </div>
                    <div class="star-method">
                        <h4><i class="fas fa-star"></i> STAR Method</h4>
                        ${starHTML}
                    </div>
                `;
            }

            async submitSession() {
                if (Object.keys(this.answers).length === 0) {
                    this.showMessage('âœ— Please answer at least one question!', 'error');
                    return;
                }

                const btn = document.getElementById('submit-session-btn');
                btn.disabled = true;
                btn.textContent = 'Saving...';

                try {
                    const response = await fetch('/api/save_interview_session', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            session_type: 'hr',
                            questions: this.questions,
                            answers: this.answers
                        })
                    });

                    const result = await response.json();
                    if (result.success) {
                        this.showMessage('âœ“ Session saved successfully!', 'success');
                        setTimeout(() => {
                            this.resetSession();
                            this.loadHistory();
                        }, 1500);
                    } else {
                        this.showMessage('âœ— Failed to save session: ' + result.error, 'error');
                    }
                } catch (error) {
                    this.showMessage('âœ— Error saving session: ' + error.message, 'error');
                } finally {
                    btn.disabled = false;
                    btn.textContent = 'Submit Session';
                }
            }

            cancelSession() {
                document.getElementById('intro-section').style.display = 'block';
                document.getElementById('questions-section').style.display = 'none';
                this.resetSession();
            }

            resetSession() {
                this.questions = [];
                this.answers = {};
                this.feedbacks = {};
                window.scrollTo(0, 0);
            }

            async loadHistory() {
                try {
                    const response = await fetch('/api/interview_history?type=hr');
                    const result = await response.json();

                    const historyList = document.getElementById('history-list');

                    if (result.success && result.sessions.length > 0) {
                        historyList.innerHTML = result.sessions.map(session => `
                            <div class="session-item">
                                <div class="session-header">
                                    <div>
                                        <h4 style="margin-bottom: 0.5rem;">Session ${session.id}</h4>
                                        <div class="session-date">
                                            <i class="fas fa-calendar"></i> ${new Date(session.created_at).toLocaleDateString()} 
                                            ${new Date(session.created_at).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}
                                        </div>
                                    </div>
                                    <span class="session-badge">${session.session_type.toUpperCase()}</span>
                                </div>
                                <div class="session-details">
                                    <div class="detail-box">
                                        <div class="detail-label">Questions</div>
                                        <div class="detail-value">${session.questions_count}</div>
                                    </div>
                                    <div class="detail-box">
                                        <div class="detail-label">Score</div>
                                        <div class="detail-value">${session.score ? session.score.toFixed(1) : 'N/A'}</div>
                                    </div>
                                    <div class="detail-box">
                                        <div class="detail-label">Status</div>
                                        <div class="detail-value"><i class="fas fa-check" style="color: var(--success);"></i></div>
                                    </div>
                                </div>
                            </div>
                        `).join('');
                    } else {
                        historyList.innerHTML = `
                            <div class="history-empty">
                                <i class="fas fa-inbox"></i>
                                <h3>No sessions yet</h3>
                                <p>Start a practice session to see your history</p>
                            </div>
                        `;
                    }
                } catch (error) {
                    document.getElementById('history-list').innerHTML = `
                        <div class="history-empty">
                            <p style="color: red;">Error loading history: ${error.message}</p>
                        </div>
                    `;
                }
            }

            showLoading() {
                document.getElementById('loading').style.display = 'block';
                document.getElementById('intro-section').style.display = 'none';
            }

            hideLoading() {
                document.getElementById('loading').style.display = 'none';
                document.getElementById('intro-section').style.display = 'block';
            }

            showMessage(text, type) {
                const message = document.getElementById('message');
                message.textContent = text;
                message.className = `message ${type}`;
                message.style.display = 'block';
                setTimeout(() => { message.style.display = 'none'; }, 5000);
            }
        }

        // Global function for tab switching
        function switchTab(tab) {
            hrManager.switchTab(tab);
        }

        const hrManager = new HRInterviewManager();
    </script>
</body>
</html>